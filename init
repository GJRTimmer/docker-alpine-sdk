#!/bin/bash

# Container Exit
cexit() {
	echo 'Container Terminated'
	exit 0
}

export TERM=xterm
DATA=/home/apk/data

USERMAP_ORIG_UID=$(id -u apk)
USERMAP_ORIG_GID=$(id -g apk)
USERMAP_UID=${USERMAP_UID:-apk}
USERMAP_GID=${USERMAP_GID:-abuild}

if [[ $USERMAP_UID != *[[:digit:]]* ]]; then
	USERMAP_UID=$(id -u $USERMAP_UID)
fi

if [[ $USERMAP_GID != *[[:digit:]]* ]]; then
	USERMAP_GID=$(id -g $USERMAP_GID)
fi

APK_GID=${APK_GID:-${APK_UID:-$USERMAP_GID}}
APK_UID=${APK_UID:-$USERMAP_UID}

if [[ ${APK_UID} != ${USERMAP_ORIG_UID} ]] || [[ ${APK_GID} != ${USERMAP_ORIG_GID} ]]; then
	echo "Adapting uid and gid for apk:abuild to ${APK_UID}:${APK_GID}"
	sed -i -e "s|:${USERMAP_ORIG_UID}:${APK_GID}:|:${APK_UID}:${APK_GID}:|" /etc/passwd
	usermod -s /bin/bash -G abuild apk
fi

# If not mounted, create data directory
if [[ ! -d ${DATA} ]]; then
	sudo -HEu apk mkdir -p ${DATA}
else 
	chown -R apk:abuild ${DATA}
	chmod 777 ${DATA}
fi

# Failsafe check, should never run
if [[ -d /home/apk/.ssh ]] && [[ ! -L /home/apk/.ssh ]]; then
	# .ssh already exists, weird...
	# Move to data and create symbolic link
	mv /home/apk/.ssh ${DATA}
	ln -s /home/apk/data/.ssh /home/apk/.ssh
fi

if [ ! -d ${DATA}/.ssh ]; then
	sudo -HEu apk mkdir -p ${DATA}/.ssh
	ln -s /home/apk/data/.ssh /home/apk/.ssh
else 
	if [[ ! -L /home/apk/.ssh ]]; then
		ln -s /home/apk/data/.ssh /home/apk/.ssh
	fi 
fi


if [ ! -d ${DATA}/.apk ]; then
	sudo -HEu apk mkdir -p ${DATA}/.apk
	cp -fra /etc/apk/keys ${DATA}/.apk/
	rm -rf /etc/apk/keys
	ln -s ${DATA}/.apk/keys /etc/apk/keys
else
	cp -ra /etc/apk/keys ${DATA}/.apk/
	rm -rf /etc/apk/keys
	ln -s ${DATA}/.apk/keys /etc/apk/keys
fi

if [ ! -d ${DATA}/.abuild ]; then
	sudo -HEu apk mkdir -p ${DATA}/.abuild
	ln -s /home/apk/data/.abuild /home/apk/.abuild
else 
	if [[ ! -L /home/apk/.abuild ]]; then
		ln -s /home/apk/data/.abuild /home/apk/.abuild
	fi
fi

if [ ! -f ${DATA}/.abuild/abuild.conf ]; then
	cp /etc/abuild.conf ${DATA}/.abuild/abuild.conf
	rm -f /etc/abuild.conf
	ln -s ${DATA}/.abuild/abuild.conf /etc/abuild.conf
	chown apk:abuild ${DATA}/.abuild/abuild.conf
	chmod 777 ${DATA}/.abuild/abuild.conf
else
	rm -f /etc/abuild.conf
	ln -s ${DATA}/.abuild/abuild.conf /etc/abuild.conf
	chown apk:abuild ${DATA}/.abuild/abuild.conf
	chmod 777 ${DATA}/.abuild/abuild.conf
fi

if [[ ! -d ${DATA}/aports ]]; then
	sudo -HEu apk git clone ${REPO_URL} ${DATA}/aports
	cd ${DATA}/aports
	sudo -HEu apk git fetch upstream
	sudo -HEu apk git checkout master
	sudo -HEu apk git merge upstream/master
	sudo -HEu apk git push origin master
else 
	cd ${DATA}/aports
	sudo -HEu apk git fetch upstream
	sudo -HEu apk git checkout master
	sudo -HEu apk git merge upstream/master
	sudo -HEu apk git push origin master
fi

# Upgrade Image
apk upgrade --update-cache --no-cache --available

trap cexit TERM

while true; do
	sleep 100 &
	wait $!
done

# EOF