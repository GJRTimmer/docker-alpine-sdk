#!/bin/sh

# Container Exit
cexit() {
	echo 'Container Terminated'
	exit 0
}

DATA=/home/apk/data

USERMAP_ORIG_UID=$(id -u apk)
USERMAP_ORIG_GID=$(id -g apk)
USERMAP_UID=${USERMAP_UID:-apk}
USERMAP_GID=${USERMAP_GID:-abuild}

if [[ $USERMAP_UID != *[[:digit:]]* ]]; then
	USERMAP_UID=$(id -u $USERMAP_UID)
fi

if [[ $USERMAP_GID != *[[:digit:]]* ]]; then
	USERMAP_GID=$(id -g $USERMAP_GID)
fi

APK_GID=${APK_GID:-${APK_UID:-$USERMAP_GID}}
APK_UID=${APK_UID:-$USERMAP_UID}

if (( ${APK_UID} != ${USERMAP_ORIG_UID} )) || (( ${APK_GID} != ${USERMAP_ORIG_GID} )); then
	echo "  Adapting uid and gid for apk:abuild to ${APK_UID}:${APK_GID}"
	sudo groupmod -o -g ${APK_GID} abuild
	sudo sed -i -e "s|:${USERMAP_ORIG_UID}:${APK_GID}:|:${APK_UID}:${APK_GID}:|" /etc/passwd
	sudo usermod -s /bin/bash apk
fi

# If not mounted, create data directory
if [ ! -d ${DATA} ]; then
	sudo -HEu apk mkdir -p ${DATA}
else 
	sudo chown apk:abuild ${DATA}
fi

# Failsafe check, should never run
if [ -d /home/apk/.ssh ]; then
	# .ssh already exists, weird...
	# Move to data and create symbolic link
	mv /home/apk/.ssh ${DATA}
	ln -s /home/apk/data/.ssh /home/apk/.ssh
fi

if [ ! -d ${DATA}/.ssh ]; then
	sudo -HEu apk mkdir -p ${DATA}/.ssh
	ln -s /home/apk/data/.ssh /home/apk/.ssh
fi

if [ ! -d ${DATA}/.apk ]; then
	sudo -HEu apk mkdir -p ${DATA}/.apk
	sudo cp -ra /etc/apk/keys ${DATA}/.apk/
	sudo rm -rf /etc/apk/keys
	sudo ln -s ${DATA}/.apk/keys /etc/apk/keys
fi

if [ ! -d ${DATA}/.abuild ]; then
	sudo -HEu apk mkdir -p ${DATA}/.abuild
	ln -s /home/apk/data/.abuild /home/apk/.abuild
fi

if [ ! -f ${DATA}/.abuild/abuild.conf ]; then
	cp /etc/abuild.conf ${DATA}/.abuild/abuild.conf
	sudo rm -f /etc/abuild.conf
	sudo ln -s ${DATA}/.abuild/abuild.conf /etc/abuild.conf
fi

if [ ! -d ${DATA}/aports ]; then
	git clone git://git.alpinelinux.org/aports ${DATA}/aports &
else 
	cd ${DATA}/aports
	git pull origin master
fi

trap cexit TERM

while true; do
	sleep 100 &
	wait $!
done

# EOF